declare @Start  date = '##StartDate##'
declare @end  date = '##EndDate##'
declare @companypageidlist table (id int)
declare @orderidlist table (id int)
insert into @companypageidlist values (5872) /*GOOGLE*/, (3976) /*Amazon*/, (11888) 
insert into @orderidlist values (176922) /*GOOGLE*/, (176910) /*Amazon*/, (175765) 

select viewtab.companyname, sum(viewtab.views), sum(clicktab.clicks), utilizationtab.utilization
from

(select sum(case when job.state = 4 and job.datestatechanged < @start then null else visitcount end) As Views, 
        jobvisits.jobid, job.companyname
    from jobvisits 
    join job on jobvisits.jobid = job.jobid
    where jobvisits.date between @start and @end
    and job.companyname in ('Facebook', 'Google', 'Amazon')
    group by jobvisits.jobid, job.companyname) Viewtab
    
full outer join
   
(select 
    case when ClicksA is not Null then ClicksA else ClicksB end As Clicks,
    case when sub1.jobid is not null then sub1.jobid else sub2.jobid end As JobID,
    case when sub1.companypageid is not null then sub1.companypageid else sub2.companypageid end as CompanyPageID

    from 

        ( select sum(ApplyButtonClickCount) As ClicksA, jobid, jabc.companypageid
        from JobApplyButtonClicks jabc
        where date between @Start and @end
        and jabc.companypageid in (select id from @companypageidlist)
        group by jobid, companypageid ) sub1
      
    full join
  
        (select sum(ApplyOutClickCount) As ClicksB, jobid, jaoc.companypageid
        from JobApplyOutClick jaoc
        where date between @Start and @end
        and jaoc.companypageid in (select id from @companypageidlist)
        group by jobid, jaoc.companypageid) sub2
    
    on sub1.jobid = sub2.jobid) Clicktab
    on Viewtab.jobid = clicktab.JobID
    
    cross join
    
    (select
    count(case when js.isavailable = 0 then 1 else null end)*100/
    (count(case when js.isavailable = 1 then 1 else null end) +
    count(case when js.isavailable = 0 then 1 else null end)) As Utilization
    from jobslot js
    where js.orderid in (select id from @orderidlist))  UtilizationTab
 
    
    
    
    group by viewtab.companyname, utilizationtab.utilization
