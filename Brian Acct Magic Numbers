--To find the company associated with a specific ID, add it to the end of the following URL
--https://talent.stackoverflow.com/employer/reporting/xx <--ID goes where the xx is

--A company's ID can be seen in the URL of the reporting tab. For example, Google's ID is (7350), as seen below
--https://talent.stackoverflow.com/employer/reporting/7350

declare @Start  date = '##StartDate##'
declare @end  date = '##EndDate##'
declare @rep char(40)
declare @companyid table (id int)
SET @rep = '##Rep##'

BEGIN

if @rep = 'BJUNG'
insert into @companyid values (55755), (15602), (4496), (16709), (56171), (56199), (419), (56285), (55817), (56143),
(56029), (5716), (13265), (15974), (1379), (16421), (55345), (55438), (16610), (55569), (16630), (56309), (56309), (55786),
(16794), (656), (7654), (15129), (1521), (11288), (16413), (16831), (3567), (56056), (3363), (55530), (16176),(56040),
(2869), (14988), (16657), (9021), (2867), (14029), (11170), (12286), (12286), (16757), (14277), (13674), (55548), (8687),
(12262), (56218), (256), (16745), (56045), (12047), (16474), (16009), (195), (16299), (8659), (11740), (13037), (56024),
(55467), (9827)


select 
companies.name,
lastlog.MostRecentLogin,
Round(sum(clicktab.clicks)*1.0/DaysRunning.DaysRunning,1) As ClicksPerJobPerDay,
Round(sum(clicktab.clicks)*100.0/viewtab.views,1) As CTR,
sum(clicktab.clicks) As Clicks, 
viewtab.views As Views,
utilizationtab.utilization,
adtab.CPA_Impressions, adtab.CPA_Clicks, adtab.CPA_CTR, Pageviewtab.PageViews,
CandidateSearch.Messages, CandidateSearch.Interested 

from

companies
right join

--Job Views  
  (select companyid, 
        sum(case when job.state = 4 and job.datestatechanged < @start then 0 else visitcount end) As Views
from job join users u on job.userid=u.id
join jobvisits jv on jv.jobid=job.jobid
where u.companyid in (select id from @companyid) and date between @start and @end
group by companyid) Viewtab
on companies.id=viewtab.companyid

--Job Clicks
left join   
        (select sum(ApplyButtonClickCount) As Clicks, companyid
        from JobApplyButtonClicks jabc join job on job.jobid = jabc.jobid
        join users on job.userid = users.id
        where date between @start and @end
        and companyid in (select id from @companyid)
        group by companyid
union
        select sum(ApplyOutClickCount) As Clicks, companyid
        from JobApplyOutClick jaoc join job on job.jobid = jaoc.jobid
        join users on job.userid = users.id
        where date between @start and @end
        and companyid in (select id from @companyid)
        group by companyid) Clicktab 
on Viewtab.companyid = clicktab.companyid

full join 
      (select u.companyid, count(case when js.isavailable = 0 then 1 else null end)*100/
    (count(case when js.isavailable = 1 then 1 else null end) +
    count(case when js.isavailable = 0 then 1 else null end)) As Utilization
    from jobslot js full outer join job j on j.jobid = js.jobid
    full outer join users u on js.userid=u.id
    where js.orderid in (
    select distinct orderid
from JobSlot js join users u on u.id=js.userid
where companyid in (select id from @companyid) and getdate() < JS.DateExpires
group by orderid) group by u.companyid) Utilizationtab
    on utilizationtab.companyid = viewtab.companyid
full join 
    (select companyid, sum(FBD.Impressions) As CPA_Impressions,
    sum(FBD.Clicks) As CPA_Clicks, 
    Round(sum(FBD.Clicks)*100.0 / sum(FBD.Impressions), 2) As CPA_CTR
    from CompanypageAdPackages CPAP
    join
    [Calculon.Metrics].dbo.FlightsByDay FBD on
    fbd.flightid = CPAP.flightid
    join users u on u.id=cpap.owneruserid
    where companyid in (select id from @companyid)
    and fbd.date between @start and @end
    group by companyid) AdTab

on adtab.companyid=clicktab.companyid

full outer join 
   (select sum(cpv.visitcount) As PageViews, companyid
  from companypagevisits cpv  
  join companypages cp on cpv.companypageid=cp.id 
  join users u on cp.userid=u.id 
  where u.companyid in (select id from @companyid)
  and date between @start and @end
  group by companyid) Pageviewtab
on pageviewtab.companyid = companies.id

full outer join 
  (select u.companyid,
count(distinct messagethreadid) As Messages,
count(distinct(case when ResponseInterestIndicator = 4 then candidateid else null end)) As Interested 
from introductions join users u on introductions.intromessagesenderuserid = u.id
join companies c on c.id = u.companyid 
where IntroMessageCreationDate
between @start and @end and u.companyid in (select id from @companyid)
group by u.companyid) CandidateSearch
on companies.id = CandidateSearch.companyid

left join
(select companies.name, companies.id, sum(datediff(dd,
case when startdate < @start then @start else startdate end,
case when enddate > @end then @end else enddate end)) As DaysRunning
from jobrunningperiods 
join job on job.jobid = jobrunningperiods.jobid
join users on users.id = job.userid
join companies on companies.id = users.companyid
and EndDate >= @start and StartDate <= @end
group by companies.name, companies.id) DaysRunning
on companies.id = DaysRunning.id

left join
(select c.id, max(lastlogindate) As MostRecentLogin
from users u join companies c on c.id=u.companyid
where companyid in (select id from @companyid)
group by c.id) lastlog
on companies.id = lastlog.id

group by companies.name, clicktab.companyid, viewtab.views, utilizationtab.utilization, 
adtab.CPA_Impressions, adtab.CPA_Clicks, adtab.CPA_CTR, Pageviewtab.PageViews,
CandidateSearch.Messages, CandidateSearch.Interested, DaysRunning.DaysRunning, MostRecentLogin

END
